"use strict";(self.webpackChunkdocsite_poc_github_io=self.webpackChunkdocsite_poc_github_io||[]).push([[43328],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=i,f=u["".concat(s,".").concat(h)]||u[h]||d[h]||a;return n?r.createElement(f,o(o({ref:t},c),{},{components:n})):r.createElement(f,o({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<a;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},52181:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var r=n(87462),i=(n(67294),n(3905));const a={title:"Configuring how events are sent",date:"2022-03-24",sidebar_position:50},o=void 0,l={unversionedId:"collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/index",id:"collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/index",title:"Configuring how events are sent",description:"A user interacts with your app: an event is generated and tracked using Tracker.track(). But the event must be sent to your event collector, to enter your pipeline, before it has any value.",source:"@site/docs/collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/index.md",sourceDirName:"collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent",slug:"/collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/",permalink:"/docs/collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/",draft:!1,editUrl:"https://github.com/snowplow/snowplow.github.io/tree/main/docs/collecting-data/collecting-from-own-applications/java-tracker/configuring-how-events-are-sent/index.md",tags:[],version:"current",lastUpdatedAt:1661522595,formattedLastUpdatedAt:"Aug 26, 2022",sidebarPosition:50,frontMatter:{title:"Configuring how events are sent",date:"2022-03-24",sidebar_position:50},sidebar:"tutorialSidebar",previous:{title:"Tracking specific client-side properties",permalink:"/docs/collecting-data/collecting-from-own-applications/java-tracker/tracking-specific-client-side-properties/"},next:{title:"What do Java tracker events look like?",permalink:"/docs/collecting-data/collecting-from-own-applications/java-tracker/what-do-java-tracker-events-look-like/"}},s={},p=[{value:"What happens if an event fails to send?",id:"what-happens-if-an-event-fails-to-send",level:3},{value:"Configuring how many events to send in one request",id:"configuring-how-many-events-to-send-in-one-request",level:3},{value:"Configuring how events are buffered",id:"configuring-how-events-are-buffered",level:3},{value:"Configuring the network connection",id:"configuring-the-network-connection",level:3},{value:"OkHttpClient",id:"okhttpclient",level:4},{value:"Apache HTTP Client",id:"apache-http-client",level:4},{value:"Configuring the Java tracker threads",id:"configuring-the-java-tracker-threads",level:3}],c={toc:p};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"A user interacts with your app: an event is generated and tracked using ",(0,i.kt)("inlineCode",{parentName:"p"},"Tracker.track()"),". But the event must be sent to your event collector, to enter your pipeline, before it has any value."),(0,i.kt)("p",null,"The Java tracker allows configuration of the network connection, event sending, and buffering of events. All of these configurations are contained within the ",(0,i.kt)("inlineCode",{parentName:"p"},"Emitter")," class. The default configurations will be sufficient for many Snowplow users."),(0,i.kt)("p",null,"The default ",(0,i.kt)("inlineCode",{parentName:"p"},"Emitter")," is the ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter"),", which sends events asynchronously in batches using POST requests. The other built-in Emitter, ",(0,i.kt)("inlineCode",{parentName:"p"},"SimpleEmitter"),", was deprecated in version 0.12. If you need to send events synchronously, or with GET requests, we have provided an ",(0,i.kt)("inlineCode",{parentName:"p"},"Emitter")," interface so you can create your own."),(0,i.kt)("p",null,"The simplest ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," initialisation looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .build();\n')),(0,i.kt)("p",null,"Only the ",(0,i.kt)("inlineCode",{parentName:"p"},"url"),' property is required. The URL path for your collector endpoint should include the protocol, "http" or "https". The Java tracker is able to send events to either. See the API docs for the full ',(0,i.kt)("a",{parentName:"p",href:"https://snowplow.github.io/snowplow-java-tracker/index.html?com/snowplowanalytics/snowplow/tracker/emitter/BatchEmitter.Builder.html"},"BatchEmitter.Builder")," and ",(0,i.kt)("a",{parentName:"p",href:"https://snowplow.github.io/snowplow-java-tracker/index.html?com/snowplowanalytics/snowplow/tracker/emitter/AbstractEmitter.Builder.html"},"AbstractEmitter.Builder")," options."),(0,i.kt)("p",null,"When an ",(0,i.kt)("inlineCode",{parentName:"p"},"Event")," is tracked using ",(0,i.kt)("inlineCode",{parentName:"p"},"Tracker.track()"),", a payload (",(0,i.kt)("inlineCode",{parentName:"p"},"TrackerPayload"),") is generated from the ",(0,i.kt)("inlineCode",{parentName:"p"},"Event"),". The payload is added to the ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter"),"'s ",(0,i.kt)("inlineCode",{parentName:"p"},"InMemoryEventStore")," buffer. This triggers a check on the size of the buffer. The number of stored events is compared with the configured ",(0,i.kt)("inlineCode",{parentName:"p"},"batchSize"),"; the default is 50 events per batch. If there are enough events, a batch's worth is asynchronously removed from the buffer for sending. The ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," prepares a request payload containing all the event payloads, and attempts to send it. On receiving a successful HTTP response code (2xx), the events are considered sent, and permanently deleted from the buffer."),(0,i.kt)("p",null,"If the event buffer is full, the payload will be dropped. Priority is given to older events. In this case, ",(0,i.kt)("inlineCode",{parentName:"p"},"Tracker.track()")," returns ",(0,i.kt)("inlineCode",{parentName:"p"},"null")," rather than the payload ",(0,i.kt)("inlineCode",{parentName:"p"},"eventId"),"."),(0,i.kt)("h3",{id:"what-happens-if-an-event-fails-to-send"},"What happens if an event fails to send?"),(0,i.kt)("p",null,"Event sending retry was added in version 0.12. If the ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClientAdapter")," returns a failure code (anything other than 2xx), the events (as ",(0,i.kt)("inlineCode",{parentName:"p"},"TrackerPayload")," objects) are returned to the buffer. They will be retried in future sending attempts. The returned events are added to the start of the buffer queue, as older events are prioritised over newer ones."),(0,i.kt)("p",null,"To prevent unnecessary requests being made while the collector is unavailable, an exponential backoff is added to all subsequent event sending attempts. This resets after a request is successful."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter.Builder")," currently has an option for setting response codes not to retry after. The intended use is for codes such as ",(0,i.kt)("inlineCode",{parentName:"p"},"401 Unauthorised")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"403 Forbidden"),". We're planning to add more sophisticated response code handling to the Java tracker in a future release. If the ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClientAdapter")," returns one of the configured fatal response codes, the events in the request payload are not returned to the buffer for another sending attempt. They are just deleted."),(0,i.kt)("p",null,"Configure no-retry response codes like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'List<Integer> noRetry = new ArrayList<>();\nnoRetry.add(403);\n\nBatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .fatalResponseCodes(noRetry)\n                .build();\n')),(0,i.kt)("p",null,"See below for information about retries within HTTP clients."),(0,i.kt)("h3",{id:"configuring-how-many-events-to-send-in-one-request"},"Configuring how many events to send in one request"),(0,i.kt)("p",null,"The BatchEmitter sends events in batches. This is more efficient than sending event requests singly, as only one set of POST headers is required for a number of events. The event collector receives the request and separates out the individual event payloads."),(0,i.kt)("p",null,"The default batch size is 50 events. If you have a high event volume, larger batches may be more suitable. However, there is a risk of creating oversized requests, which could result in ",(0,i.kt)("inlineCode",{parentName:"p"},"413 Payload Too Large")," responses from your collector. The Java tracker does not currently have the ability to split oversized requests into smaller ones."),(0,i.kt)("p",null,"Configure the batch size like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .batchSize(10)\n                .build();\n\n// Batch size can be updated after initialization\nemitter.setBatchSize(100)\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"batchSize")," property was called ",(0,i.kt)("inlineCode",{parentName:"p"},"bufferSize")," in versions before 0.12."),(0,i.kt)("h3",{id:"configuring-how-events-are-buffered"},"Configuring how events are buffered"),(0,i.kt)("p",null,"The Java tracker sends events asynchronously: the application is not blocked waiting for the tracked event to be sent. The tracked events are stored in memory until there are enough to send, or while the network is down. The default event store is ",(0,i.kt)("inlineCode",{parentName:"p"},"InMemoryEventStore"),", added in version 0.12. This class stores the payloads in a queue, specifically a ",(0,i.kt)("inlineCode",{parentName:"p"},"LinkedBlockingDeque"),"."),(0,i.kt)("p",null,"We recommend setting the maximum capacity of the default event buffer queue at ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," initialization. This is the number of events that can be stored. When the buffer is full, new tracked payloads are dropped, so choosing the right capacity is important. The default buffer capacity is that of a ",(0,i.kt)("inlineCode",{parentName:"p"},"LinkedBlockingDeque"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"Integer.MAX_VALUE"),". It's likely your application would run out of memory before buffering that many events."),(0,i.kt)("p",null,"Creating a ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," with a specified maximum buffer capacity:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .bufferCapacity(100000)\n                .build();\n')),(0,i.kt)("p",null,"This BatchEmitter will store 100 000 events before starting to lose data."),(0,i.kt)("p",null,"We also provide an ",(0,i.kt)("inlineCode",{parentName:"p"},"EventStore")," interface. To use a custom EventStore:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .eventStore(EventStore)\n                .build();\n')),(0,i.kt)("p",null,"If ",(0,i.kt)("inlineCode",{parentName:"p"},"bufferCapacity")," is provided at the same time as ",(0,i.kt)("inlineCode",{parentName:"p"},"eventStore"),", the ",(0,i.kt)("inlineCode",{parentName:"p"},"bufferCapacity")," value will be discarded."),(0,i.kt)("h3",{id:"configuring-the-network-connection"},"Configuring the network connection"),(0,i.kt)("p",null,"We currently offer two different HTTP clients that can be used to send events to your collector: OkHttp or Apache HTTP. Both libraries have broadly the same features, with some differences in their default configurations. If neither of these HTTP clients is suitable, we also provide an ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClientAdapter")," interface. The ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClientAdapter")," is a wrapper for HTTP client objects."),(0,i.kt)("p",null,"Note for Gradle users: ",(0,i.kt)("a",{parentName:"p",href:"/docs/collecting-data/collecting-from-own-applications/java-tracker/installation-and-set-up/"},"different dependencies")," are required if you are using OkHttp or Apache HTTP."),(0,i.kt)("p",null,"By default, the Java tracker uses OkHttp; an ",(0,i.kt)("inlineCode",{parentName:"p"},"OkHttpClientAdapter")," object is generated when a ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," is created. To specify a different client adapter, initialize the ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"BatchEmitter emitter = BatchEmitter.builder()\n                .httpClientAdapter(HttpClientAdapter)\n                .build();\n")),(0,i.kt)("p",null,"Note that ",(0,i.kt)("inlineCode",{parentName:"p"},"url")," is not a required method when an ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClientAdapter")," is specified. The ",(0,i.kt)("inlineCode",{parentName:"p"},"url")," collector endpoint is normally used to create the default ",(0,i.kt)("inlineCode",{parentName:"p"},"OkHttpClientAdapter"),", therefore if ",(0,i.kt)("inlineCode",{parentName:"p"},"url")," was provided here, it would be ignored."),(0,i.kt)("p",null,"HTTP request retry can be configured within the HTTP clients, on top of the Java tracker's handling of unsuccessful requests. The default HTTP client, OkHttp, ",(0,i.kt)("a",{parentName:"p",href:"https://square.github.io/okhttp/4.x/okhttp/okhttp3/-ok-http-client/-builder/retry-on-connection-failure/"},"retries after certain types of connection failure")," by default. The Apache HTTP Client ",(0,i.kt)("a",{parentName:"p",href:"https://www.javadoc.io/doc/org.apache.httpcomponents/httpclient/4.3.5/org/apache/http/impl/client/DefaultHttpRequestRetryHandler.html"},"retries a request up to 3 times")," by default."),(0,i.kt)("h4",{id:"okhttpclient"},"OkHttpClient"),(0,i.kt)("p",null,"The simplest OkHttpClient initialization looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"OkHttpClient client = new OkHttpClient();\n")),(0,i.kt)("p",null,"This is the default as used in the ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter"),". To add configuration, instead use the ",(0,i.kt)("inlineCode",{parentName:"p"},"OkHttpClient.Builder"),". For example, setting timeouts:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'OkHttpClient client = new OkHttpClient.Builder()\n      .connectTimeout(5, TimeUnit.SECONDS)\n      .readTimeout(5, TimeUnit.SECONDS)\n      .writeTimeout(5, TimeUnit.SECONDS)\n      .build();\n\nHttpClientAdapter adapter = OkHttpClientAdapter.builder()\n      .url("http://collector-endpoint.com")\n      .httpClient(client)\n      .build();\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"url")," is the URL for your collector. See ",(0,i.kt)("a",{parentName:"p",href:"https://square.github.io/okhttp/3.x/okhttp/okhttp3/OkHttpClient.Builder.html"},"Square's API docs")," for the full list of options."),(0,i.kt)("h4",{id:"apache-http-client"},"Apache HTTP Client"),(0,i.kt)("p",null,"The simplest Apache HTTP Client initialization looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"CloseableHttpClient client = HttpClients.createDefault();\n")),(0,i.kt)("p",null,"You are encouraged to research how best to set up your Apache Client for maximum performance. For example, by default the Apache Client will never time out, and will also allow only two outbound connections at a time. In this code block, a ",(0,i.kt)("inlineCode",{parentName:"p"},"PoolingHttpClientConnectionManager")," is used to allow up to 50 concurrent outbound connections:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'PoolingHttpClientConnectionManager manager = new PoolingHttpClientConnectionManager();\nmanager.setDefaultMaxPerRoute(50);\n\nCloseableHttpClient client = HttpClients.custom()\n      .setConnectionManager(manager)\n      .build();\n\nHttpClientAdapter adapter = ApacheHttpClientAdapter.builder()\n      .url("http://collector-endpoint.com")\n      .httpClient(client)\n      .build();\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"url")," is the URL for your collector. See ",(0,i.kt)("a",{parentName:"p",href:"https://hc.apache.org/httpcomponents-client-4.5.x/index.html"},"Apache's HttpClient docs")," for more information about configuring the client."),(0,i.kt)("h3",{id:"configuring-the-java-tracker-threads"},"Configuring the Java tracker threads"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"BatchEmitter")," contains threads for concurrent event sending. This is managed by an ",(0,i.kt)("inlineCode",{parentName:"p"},"ScheduledThreadPoolExecutor"),'. By default, the thread pool has up to 50 threads, helpfully named e.g. "snowplow-emitter-pool-1-request-thread-1". The bigger the pool of threads, the faster events can be sent. Set the number of threads depending on many events you are sending, and how strong a computer the tracker is running on.'),(0,i.kt)("p",null,"The process of getting events from the buffer, creating a request payload, and sending the POST request occurs within a single thread."),(0,i.kt)("p",null,"Specifying the maximum number of event sending threads, in this case to 1:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .threadCount(1)\n                .build();\n')),(0,i.kt)("p",null,"It's also possible to provide your own ",(0,i.kt)("inlineCode",{parentName:"p"},"ScheduledExecutorService"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'BatchEmitter emitter = BatchEmitter.builder()\n                .url("http://collector-endpoint")\n                .requestExecutorService(ScheduledExecutorService)\n                .build();\n')),(0,i.kt)("p",null,"The default thread pool uses non-daemon threads. To stop the threads and shut down the ",(0,i.kt)("inlineCode",{parentName:"p"},"ExecutorService"),", call ",(0,i.kt)("inlineCode",{parentName:"p"},"Emitter.close()"),". There is no way to restart the ",(0,i.kt)("inlineCode",{parentName:"p"},"Emitter")," after this."))}d.isMDXComponent=!0}}]);