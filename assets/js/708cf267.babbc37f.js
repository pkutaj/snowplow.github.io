"use strict";(self.webpackChunkdocsite_poc_github_io=self.webpackChunkdocsite_poc_github_io||[]).push([[76571],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=i,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||r;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},42546:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const r={title:"Custom SQL enrichment",date:"2020-02-14",sidebar_position:90},o=void 0,l={unversionedId:"enriching-your-data/available-enrichments/custom-sql-enrichment/index",id:"enriching-your-data/available-enrichments/custom-sql-enrichment/index",title:"Custom SQL enrichment",description:"Summary",source:"@site/docs/enriching-your-data/available-enrichments/custom-sql-enrichment/index.md",sourceDirName:"enriching-your-data/available-enrichments/custom-sql-enrichment",slug:"/enriching-your-data/available-enrichments/custom-sql-enrichment/",permalink:"/docs/enriching-your-data/available-enrichments/custom-sql-enrichment/",draft:!1,editUrl:"https://github.com/snowplow/snowplow.github.io/tree/main/docs/enriching-your-data/available-enrichments/custom-sql-enrichment/index.md",tags:[],version:"current",lastUpdatedAt:1661352356,formattedLastUpdatedAt:"Aug 24, 2022",sidebarPosition:90,frontMatter:{title:"Custom SQL enrichment",date:"2020-02-14",sidebar_position:90},sidebar:"tutorialSidebar",previous:{title:"UA parser enrichment",permalink:"/docs/enriching-your-data/available-enrichments/ua-parser-enrichment/"},next:{title:"Event fingerprint enrichment",permalink:"/docs/enriching-your-data/available-enrichments/event-fingerprint-enrichment/"}},s={},p=[{value:"Summary",id:"summary",level:2},{value:"Overview",id:"overview",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Hypothetical example",id:"hypothetical-example",level:2},{value:"Configuration",id:"configuration-1",level:2},{value:"<code>inputs</code>",id:"inputs",level:4},{value:"<code>database</code>",id:"database",level:4},{value:"<code>query</code>",id:"query",level:4},{value:"<code>output</code>",id:"output",level:4},{value:"<code>cache</code>",id:"cache",level:4},{value:"Examples",id:"examples",level:2},{value:"Single row",id:"single-row",level:3},{value:"Multiple rows",id:"multiple-rows",level:3},{value:"Algorithm",id:"algorithm",level:3},{value:"Data generated",id:"data-generated",level:3}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"The SQL Query Enrichment lets you perform dimension widening on a Snowplow event via your own internal relational database."),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("p",null,"If you have data points that you\u2019d like to use to enrich your event data collected with Snowplow that live in a data base, this enrichment will help you to query for the fields you want to add."),(0,i.kt)("p",null,"Currently supported database types:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"MySQL, plus variants which speak MySQL (e.g. MariaDB, Amazon Aurora)"),(0,i.kt)("li",{parentName:"ul"},"PostgreSQL, plus variants which speak PostgreSQL")),(0,i.kt)("p",null,"We don\u2019t recommend to use this enrichment with analytical databases which support minimal (50-100) concurrent queries (e.g. Redshift)."),(0,i.kt)("p",null,"To read more detail on this enrichnment and its configuration, look\xa0",(0,i.kt)("a",{parentName:"p",href:"https://github.com/snowplow/snowplow/wiki/SQL-Query-enrichment"},"here"),"."),(0,i.kt)("p",null,"For help with configuring this enrichment and getting it live on your pipeline please contact us at ",(0,i.kt)("a",{parentName:"p",href:"mailto:support@snowplowanalytics.com"},"support@snowplowanalytics.com"),"."),(0,i.kt)("h2",{id:"configuration"},"Configuration"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/snowplow/iglu-central/blob/master/schemas/com.snowplowanalytics.snowplow.enrichments/sql_query_enrichment_config/jsonschema/1-0-0"},"schema")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/snowplow/enrich/blob/master/config/enrichments/sql_query_enrichment_config.json"},"example"))),(0,i.kt)("h2",{id:"hypothetical-example"},"Hypothetical example"),(0,i.kt)("p",null,"Below you can see an example configuration using imaginary PostgreSQL database with CRM data, used to widen Snowplow event with context containing information about users."),(0,i.kt)("p",null,"The configuration JSON for this enrichment contains four sub-objects:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"inputs"),"\xa0specifies the datapoint(s) from the Snowplow event to use as values to substitute placeholders in\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"query"),"\xa0when performing SQL query"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"database"),"\xa0defines how the enrichment can access your relational database"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"query"),"\xa0defines prepared SQL statement to query your database"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"output"),"\xa0lets you tune how you convert the returned row(s) into one or more self-describing JSONs ready to be attached to your Snowplow event"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"cache"),"\xa0improves the enrichment\u2019s performance by storing rows retrieved from your relational database")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n  "schema": "iglu:com.snowplowanalytics.snowplow.enrichments/sql_query_enrichment_config/jsonschema/1-0-0",\n  "data": {\n    "name": "sql_query_enrichment_config",\n    "vendor": "com.snowplowanalytics.snowplow.enrichments",\n    "enabled": true,\n    "parameters": {\n      "inputs": [\n        {\n          "placeholder": 1,\n          "pojo": {\n            "field": "user_id"\n          }\n        },\n        {\n          "placeholder": 1,\n          "json": {\n            "field": "contexts",\n            "schemaCriterion": "iglu:com.snowplowanalytics.snowplow/client_session/jsonschema/1-*-*",\n            "jsonPath": "$.userId"\n          }\n        },\n        {\n          "placeholder": 2,\n          "pojo": {\n            "field": "app_id"\n          }\n        }\n      ],\n      "database": {\n        "postgresql": {\n          "host": "rdms.intra.acme.com",\n          "port": 5439,\n          "sslMode": true,\n          "username": "snowplow_enrich_ro",\n          "password": "1asIkJed",\n          "database": "crm"\n        }\n      },\n      "query": {\n        "sql": "SELECT username, email_address, date_of_birth FROM tbl_users WHERE user = ? AND application = ? LIMIT 1"\n      },\n      "output": {\n        "expectedRows": "AT_MOST_ONE",\n        "json": {\n          "schema": "iglu:com.acme/user/jsonschema/1-0-0",\n          "describes": "ALL_ROWS",\n          "propertyNames": "CAMEL_CASE"\n        }\n      },\n      "cache": {\n        "size": 3000,\n        "ttl": 60\n      }\n    }\n  }\n}\n')),(0,i.kt)("h2",{id:"configuration-1"},"Configuration"),(0,i.kt)("h4",{id:"inputs"},(0,i.kt)("inlineCode",{parentName:"h4"},"inputs")),(0,i.kt)("p",null,"Specify an array of\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"inputs"),"\xa0to put instead of placeholders in prepared statement. Each input consists of a\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"placeholder"),"\xa0and a source: either\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"pojo"),"\xa0if the datapoint comes from the Snowplow enriched event POJO, or\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"json"),"\xa0if the datapoint comes from a self-describing JSON inside one of the three JSON fields. The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"placeholder"),"\xa0is the index of the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"?"),"\xa0SQL placeholder which this input will be used to populate. It must be an integer greater than or equal to 1. For the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"pojo"),"\xa0source, the field name must be specified. A field name which is not recognized as part of the POJO will be ignored by the enrichment. For the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"json"),"\xa0source, you must specify the field name as either\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"unstruct_event"),",\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"contexts"),"\xa0or\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),". You must then provide two additional fields:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"schemaCriterion"),"\xa0lets you specify the self-describing JSON you are looking for in the given JSON field. You can specify only the SchemaVer MODEL (e.g.\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"1-*-*"),"), MODEL plus REVISION (e.g.\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"1-1-*"),") or a full MODEL-REVISION-ADDITION version (e.g.\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"1-1-1"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"jsonPath"),"\xa0lets you provide the\xa0",(0,i.kt)("a",{parentName:"li",href:"https://github.com/gatling/jsonpath#jsonpath"},"JSON Path statement"),"\xa0to navigate to the field inside the JSON that you want to use as the input")),(0,i.kt)("p",null,"The lookup algorithm is short-circuiting: the first match for a given key will be used."),(0,i.kt)("h4",{id:"database"},(0,i.kt)("inlineCode",{parentName:"h4"},"database")),(0,i.kt)("p",null,"The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"database"),"\xa0section lets you configure how the enrichment should access your relational database. At the moment\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"postgresql"),"\xa0and\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"mysql"),"\xa0are supported, with the same fields available for both. Please see the\xa0",(0,i.kt)("strong",{parentName:"p"},"Database support"),"\xa0section above for notes on compatibility. Populate all properties in the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"postgresql"),"\xa0or\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"mysql"),"\xa0configuration object, as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"host"),", the hostname or IP address of the database server or cluster"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"port"),", the port to connect to the database on"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"sslMode"),", whether the database requires connections to use SSL"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"username"),", the username to login to the database using"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"password"),", the password for this username"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"database"),", the name of the specific database to run the query against")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"We strongly recommend that the username have minimal read-only permissions on just the entities required to execute the SQL query."),"\xa0If your database server has additional authentication in place, such as IP whitelisting, you will need to configure this security to permit access from all of your servers running the Snowplow Enrichment process."),(0,i.kt)("h4",{id:"query"},(0,i.kt)("inlineCode",{parentName:"h4"},"query")),(0,i.kt)("p",null,"Consists of a single\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"sql"),"\xa0key with SQL query in a form of prepared statement to run on your relational database to return row(s) to attach to this event. Form of a prepared statement means it can has placeholders (",(0,i.kt)("inlineCode",{parentName:"p"},"?"),"), which will be replaced with actual values, extracted from\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"input"),"s corresponding to their indexes. Some notes on the behavior:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If a placeholder index required in the\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"sql"),"\xa0prepared statement is not found in any of the\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"inputs"),", then the lookup will not proceed, but this will\xa0",(0,i.kt)("strong",{parentName:"li"},"not"),"\xa0be flagged as a failure"),(0,i.kt)("li",{parentName:"ul"},"A final\xa0",(0,i.kt)("inlineCode",{parentName:"li"},";"),"\xa0is optional"),(0,i.kt)("li",{parentName:"ul"},"Values will be inserted into prepared statement according to their type: strings will be quoted, number won\u2019t"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"This enrichment makes no attempt to sanitize the SQL statement, nor to verify that the SQL statement does not have harmful side effects (such as SQL injection)"))),(0,i.kt)("h4",{id:"output"},(0,i.kt)("inlineCode",{parentName:"h4"},"output")),(0,i.kt)("p",null,"The enrichment adds the returned row(s) into the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0field within a Snowplow enriched event. Because all JSONs in the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0field must be self-describing JSONs, use the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"schema"),"\xa0field to specify the Iglu schema URI that you want to attach to the event. The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"expectedRows"),"\xa0enum defines expected SQL output and can take the following values:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EXACTLY_ONE"),"\xa0\u2013 exactly one row is expected. 0 or 2+ rows will throw an error, causing the entire event to fail processing"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AT_MOST_ONE"),"\xa0\u2013 either one or zero rows is expected. 2+ rows will throw an error"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AT_LEAST_ZERO"),"\xa0\u2013 between 0 and N rows are expected \u2013 in JSON terms we are dealing with an array of results"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AT_LEAST_ONE"),"\xa0\u2013 between 1 and N rows are expected \u2013 i.e. an array of results. 0 rows will throw an error")),(0,i.kt)("p",null,"It is on user\u2019s behalf to make sure SQL query returns correct amount of rows. The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"describes"),"\xa0property dictates whether the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"schema"),"\xa0is the self-describing schema for all rows returned by the query, or whether the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"schema"),"\xa0should be attached to each of the returned rows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ALL_ROWS"),"\xa0means that the\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"schema"),"\xa0should box all returned rows \u2013 i.e. one context will always be added to\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"derived_contexts"),", regardless of how many rows that schema contains"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EVERY_ROW"),"\xa0means that the\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"schema"),"\xa0should be attached to each returned row \u2013 so e.g. if 3 rows are returned, 3 contexts with this same schema will be added to\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"derived_contexts"))),(0,i.kt)("p",null,"The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"propertyNames"),"\xa0property supports reformatting of the returned columns to fit the JSON Schema\u2019s conventions better. Supported options are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AS_IS"),"\xa0\u2013 preserve the column names exactly as they are"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"CAMEL_CASE"),"\xa0\u2013 so\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"date_of_birth"),"\xa0becomes\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"dateOfBirth")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"PASCAL_CASE"),"\xa0\u2013 so\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"date_of_birth"),"\xa0becomes\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"DateOfBirth")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"SNAKE_CASE"),"\xa0\u2013 so\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"dateOfBirth"),"\xa0becomes\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"date_of_birth")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"LOWER_CASE"),"\xa0\u2013 changes all characters to lowercase"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"UPPER_CASE"),"\xa0\u2013 changes all characters to uppercase")),(0,i.kt)("p",null,"If these options aren\u2019t bespoke enough, remember that you can use column aliasing in your SQL statement to tweak individual column names."),(0,i.kt)("h4",{id:"cache"},(0,i.kt)("inlineCode",{parentName:"h4"},"cache")),(0,i.kt)("p",null,"A Snowplow enrichment can run many millions of time per hour, effectively launching a DoS attack on a data source if we are not careful. The\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"cache"),"\xa0configuration attempts to minimize the number of lookups performed. The cache is an LRU (least-recently used) cache, where less frequently accessed values are evicted to make space for new values. For the cache key, we use a complex object with an underlying Indexed HashMap, consisting of placeholder numbers as keys and extracted values as HashMap values. You can configure the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"cache"),"\xa0as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"size"),"\xa0is the maximum number of entries to hold in the cache at any one time"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ttl"),"\xa0is the number of seconds that an entry can stay in the cache before it is forcibly evicted. This is useful to prevent stale values from being retrieved in the case that your DB can return different values for the same key over time")),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("h3",{id:"single-row"},"Single row"),(0,i.kt)("p",null,"With this configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'...\n  "query": {\n    "sql": "SELECT username, date_of_birth FROM tbl_users WHERE user = ?"\n  },\n  "output": {\n    "expectedRows": "AT_MOST_ONE",\n    "json": {\n      "schema": "iglu:com.acme/user/jsonschema/1-0-0",\n      "describes": "ALL_ROWS",\n      "propertyNames": "CAMEL_CASE"\n    }\n  },\n...\n')),(0,i.kt)("p",null,"And this query result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"SELECT username, date_of_birth FROM tbl_users WHERE user = 123;\n| username | date_of_birth |\n|----------|---------------|\n|     karl |    1980-06-12 |\n")),(0,i.kt)("p",null,"This would be added to the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0array:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n  "schema": "iglu:com.acme/user/jsonschema/1-0-0",\n  "data": {\n    "username": "karl",\n    "dateOfBirth": "1980-06-12T00:00:00"\n  }\n}\n')),(0,i.kt)("p",null,"With this query result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"SELECT username, date_of_birth FROM tbl_users WHERE user = 123;\n| username | date_of_birth |\n|----------|---------------|\n")),(0,i.kt)("p",null,"No context would be added to the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0array, but the event would continue processing. With this query result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"SELECT username, date_of_birth FROM tbl_users WHERE user = 123;\n| username | date_of_birth |\n|----------|---------------|\n|     karl |    1980-06-12 |\n|     mary |    1975-03-22 |\n")),(0,i.kt)("p",null,"An error would be triggered, on account of the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"AT_MOST_ONE"),"\xa0setting, and the event would be rejected."),(0,i.kt)("h3",{id:"multiple-rows"},"Multiple rows"),(0,i.kt)("p",null,"With this configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'...\n  "query": {\n    "sql": "SELECT * FROM product WHERE category = ?"\n  },\n  "output": {\n    "expectedRows": "AT_LEAST_ZERO",\n    "json": {\n      "schema": "iglu:com.acme/products/jsonschema/1-0-0",\n      "describes": "ALL_ROWS",\n      "propertyNames": "AS_IS"\n    }\n  },\n...\n')),(0,i.kt)("p",null,"And this query result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"SELECT * FROM product WHERE category = 'homeware';\n| SKU | prod_name |\n|-----|-----------|\n| 123 |      iPad |\n| 456 |  Ray-Bans |\n")),(0,i.kt)("p",null,"This single context would be added to the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0array:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n  "schema": "iglu:com.acme/products/jsonschema/1-0-0",\n  "data": [\n    {\n      "SKU": "123",\n      "prod_name": "iPad"\n    },\n    {\n      "SKU": "456",\n      "prod_name": "Ray-Bans"\n    }    \n  ]\n}\n')),(0,i.kt)("p",null,"If we change the configuration to:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'...\n  "output": {\n    "expectedRows": "AT_LEAST_ZERO",\n    "json": {\n      "schema": "iglu:com.acme/product/jsonschema/1-0-0",\n      "describes": "EVERY_ROW",\n      "propertyNames": "LOWER_CASE"\n    }\n  }\n...\n')),(0,i.kt)("p",null,"Then two contexts would be added to the\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0array:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n  "schema": "iglu:com.acme/product/jsonschema/1-0-0",\n  "data": {\n    "sku": "123",\n    "prod_name": "iPad"\n  }\n}\n{\n  "schema": "iglu:com.acme/product/jsonschema/1-0-0",\n  "data": {\n    "sku": "456",\n    "prod_name": "Ray-Bans"\n  }\n}\n')),(0,i.kt)("h3",{id:"algorithm"},"Algorithm"),(0,i.kt)("p",null,"This enrichment uses any relational database to fetch data in JSON format. Here are some clues on how this enrichment will handle some exceptional cases:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"if provided JSONPath is invalid \u2013 all events attempted to being enriched will be sent to\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"enriched/bad")),(0,i.kt)("li",{parentName:"ul"},"if more than one context (derived or custom) matches\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"schemaCriterion"),"\xa0\u2013 first one will be picked, no matter if following have higher SchemaVer"),(0,i.kt)("li",{parentName:"ul"},"if input\u2019s value found more than in one sources \u2013 last one will be picked, so try to put more precise input last (for example to get longitude/latitude pair use data from IP Lookup enrichment first and GPS-derived longitude/latitude second)"),(0,i.kt)("li",{parentName:"ul"},"if any of input key wasn\u2019t found \u2013 SQL query won\u2019t be performed and new context won\u2019t be derived, but event will be processed as usual"),(0,i.kt)("li",{parentName:"ul"},"if DB query wasn\u2019t successful for any reason or timed-out \u2013 event will be sent to\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"enriched/bad"),"\xa0bucket"),(0,i.kt)("li",{parentName:"ul"},"if DB connection was lost \u2013 event will be sent to\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"enriched/bad"),"\xa0bucket, but on next event, enrichment will try to reestablish connection"),(0,i.kt)("li",{parentName:"ul"},"all non-primitive values (objects, arrays) and\xa0",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"s will be interpreted as not-found values")),(0,i.kt)("h3",{id:"data-generated"},"Data generated"),(0,i.kt)("p",null,"This enrichment adds a new context to the enriched event with ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/snowplow/iglu-central/blob/master/schemas/com.snowplowanalytics.snowplow/ua_parser_context/jsonschema/1-0-0"},"this schema"),"."),(0,i.kt)("p",null,"As during the SQL Query enrichment process the new context is added to\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"derived_contexts"),"\xa0of the enriched/good event, the data generated will end up in its own table determined by the custom\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"schema"),"\xa0key in\xa0",(0,i.kt)("inlineCode",{parentName:"p"},"output"),"\xa0configuration sub-object."))}d.isMDXComponent=!0}}]);