"use strict";(self.webpackChunkdocsite_poc_github_io=self.webpackChunkdocsite_poc_github_io||[]).push([[55582],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=p(n),m=o,k=u["".concat(s,".").concat(m)]||u[m]||c[m]||r;return n?a.createElement(k,l(l({ref:t},d),{},{components:n})):a.createElement(k,l({ref:t},d))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var p=2;p<r;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},27109:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>p,toc:()=>c});var a=n(87462),o=(n(67294),n(3905));const r={toc:[]};function l(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},r,n,{components:t,mdxType:"MDXLayout"}))}l.isMDXComponent=!0;const i={title:"Configure the Stream Collector",date:"2020-09-16",sidebar_position:30},s=void 0,p={unversionedId:"pipeline-components-and-applications/stream-collector/configure/index",id:"pipeline-components-and-applications/stream-collector/configure/index",title:"Configure the Stream Collector",description:"This is a complete list of the options that can be configured in the collector HOCON config file. The\xa0example configs in github\xa0show how to prepare an input file. Some features are described in more detail at the bottom of this page.",source:"@site/docs/pipeline-components-and-applications/stream-collector/configure/index.md",sourceDirName:"pipeline-components-and-applications/stream-collector/configure",slug:"/pipeline-components-and-applications/stream-collector/configure/",permalink:"/docs/pipeline-components-and-applications/stream-collector/configure/",draft:!1,editUrl:"https://github.com/snowplow/snowplow.github.io/tree/main/docs/pipeline-components-and-applications/stream-collector/configure/index.md",tags:[],version:"current",lastUpdatedAt:1661771342,formattedLastUpdatedAt:"Aug 29, 2022",sidebarPosition:30,frontMatter:{title:"Configure the Stream Collector",date:"2020-09-16",sidebar_position:30},sidebar:"tutorialSidebar",previous:{title:"Set up the stream collector",permalink:"/docs/pipeline-components-and-applications/stream-collector/setup/"},next:{title:"Sqs2kinesis",permalink:"/docs/pipeline-components-and-applications/sqs2kinesis/"}},d={},c=[{value:"Common options",id:"common-options",level:3},{value:"Kinesis collector options",id:"kinesis-collector-options",level:3},{value:"Pubsub collector options",id:"pubsub-collector-options",level:3},{value:"Setting the domain name",id:"setting-the-domain-name",level:3},{value:"Configuring custom paths",id:"configuring-custom-paths",level:3},{value:"TLS port binding and certificate (2.4.0+)",id:"tls-port-binding-and-certificate-240",level:3},{value:"Setting up an SQS buffer (2.0.0+)",id:"setting-up-an-sqs-buffer-200",level:3},{value:"Setting up the SQS queues",id:"setting-up-the-sqs-queues",level:4},{value:"Telemetry",id:"telemetry",level:4}],u={toc:c};function m(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)(l,{mdxType:"Block3445"}),(0,o.kt)("p",null,"This is a complete list of the options that can be configured in the collector HOCON config file. The\xa0",(0,o.kt)("a",{parentName:"p",href:"https://github.com/snowplow/stream-collector/tree/master/examples"},"example configs in github"),"\xa0show how to prepare an input file. Some features are described in more detail at the bottom of this page."),(0,o.kt)("h3",{id:"common-options"},"Common options"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"collector.interface"),(0,o.kt)("th",{parentName:"tr",align:null},"Required. E.g. 0.0.0.0. The collector listens for http requests on this interface."))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.port"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. The collector listens for http requests on this port.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.ssl.enable"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default is false. The collector will also listen for https requests on a different port.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.ssl.port"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 443. The port on which to listen for https requests")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.ssl.redirect"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. If enabled, the collector redirects http requests to the https endpoint using a 301 status code")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.paths"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. There are more details about this feature below. This is for customising the collector's endpoints. You can also map any valid (ie, two-segment) path to one of the three default paths.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.p3p.policyRef"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, defaults to /w3c/p3p.xml. Configures the p3p http header.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.p3p.CP"),(0,o.kt)("td",{parentName:"tr",align:null},"Optiona,l, defaults to NOI DSP COR NID PSA OUR IND COM NAV STA. Configures the p3p http header.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.crossDomain.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default is false. If enabled, the /crossdomain.xml endpoint returns a cross domain policy file.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.crossDomain.domains"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default ","[*]"," meaning the cross domain policy file allows all domains. You could change this to a list of domains.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.crossDomain.secure"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default true. Configures whether the cross domain policy file grants access to just HTTPS or both HTTP and HTTPS sources")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default true. The collector sets a cookie to set the user's network user id. Change this to false to disable setting cookies.Regardless of this setting, if the collector receives a request with the custom SP-Anonymous:* header, no cookie will be set. You can control whether this header is set or not in your tracking implementation.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.expiration"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 365 days. Configures the expiry of the collector's cookie.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.name"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default sp. Configures the name of the collector's cookie.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.domains"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default to no domains. There is more details about this feature below. This is for fine control over the cookie's domain attribute.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.fallbackDomain"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. If set, the fallback domain will be used for the cookie if none of the Origin header hosts matches the list of cookie domains.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.secure"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default true. Sets the secure property of the cookie.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.httpOnly"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default true. Sets the httpOnly property of the cookie.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookie.sameSite"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default None. Sets the sameSite property of the cookie, so it can be Strict, Lax or None")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.doNotTrackCookie.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional, default false. If enabled, the collector respects a "do not track" cookie. If the cookie is present, it returns a 200 status code but it does not log the request to the output queue.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"colletor.doNotTrackCookie.name"),(0,o.kt)("td",{parentName:"tr",align:null},"Required when the doNotTrackCookie feature is enabled. Configures the name of the cookie in which to check if tracking is disabled.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.doNotTrackCookie.value"),(0,o.kt)("td",{parentName:"tr",align:null},"Required when the doNotTrackCookie feature is enabled. Can be a regular expression. The value of the cookie must match this expression in order for the collector to respect the cookie.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookieBounce.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. When enabled, when the cookie is missing, the collector performs a redirect to itself to check if third-party cookies are blocked using the specified name. If they are indeed blocked, fallbackNetworkId is used instead of generating a new random one.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookieBounce.name"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default n3pc. The name of the request parameter which will be used on redirects checking that the third-party cookies work")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookieBounce.fallbackNetworkUserId"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 00000000-0000-4000-A000-000000000000. Network user id to use when third-party cookies are blocked.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cookieBounce.forwardedProtocolHeader"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. E.g. X-Forwarded-Proto. The header containing the originating protocol for use in the bounce redirect location. Use this if behind a load balancer that performs SSL termination.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.enableDefaultRedirect"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. When enabled, the collector's /r endpoint returns a 302 status code with a redirect back to a url specified with the ?u= query parameter.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.redirectDomainsAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. Domains which are valid for collector redirects. If empty (the default) then redirects are allowed to any domain.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.redirectMacro.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. When enabled, the redirect url passed via the u query parameter is scanned for a placeholder token. All occurrences of the placeholder are substituted with the cookie's network user id.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.redirectMacro.placeholder"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default ${SP_NUID}.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.rootResponse.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional, default false. Enable custom response handling for the root "/" path.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.rootResponse.statusCode"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 302. The http status code to use when root response is enabled.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.rootResponse.headers"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. A map of key value pairs to include in the root response headers.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.rootResponse.body"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. The http response body to use when root response is enabled.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.cors.accessControlMaxAge"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional, default "60 minutes". Configures how long a the results of a preflight request can be cached by the browser. -1 seconds disables the cache.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.preTerminationPeriodAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional, default "10 seconds". Configures how long the collector should pause after receiving a sigterm before starting the graceful shutdown. During this period the collector continues to accept new connections and respond to requests.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.preTerminationUnhealthyAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. During the preTerminationPeriod, the collector can be configured to return 503s on the /health endpoint. Can be helpful for removing the collector from a load balancer's targets.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.terminationDeadlineAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional, default "10 seconds". The akka server\'s deadline for closing connections during graceful shutdown.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.prometheusMetrics.enabled"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. When enabled, all requests are logged as prometheus metrics and the /metrics endpoint returns the report about the metrics.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.prometheusMetrics.durationBucketsInSeconds"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, e.g. ","[0.1, 3, 10]",". Custom buckets for the http_request_duration_seconds_bucket duration prometheus metric.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.telemetry.disable"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. Disable collecting meta-information about the running application. We use telemetry to help us improve the Snowplow product.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.telemetry.userProvidedId"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. It would help us out a lot if you provide a string unique to you, e.g. a uuid or your company name.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.experimental.warmup.enableAdded in version 2.7.0"),(0,o.kt)("td",{parentName:"tr",align:null},'Optional experimental feature, default false. When enabled, the collector sends some "warm-up" requests to its own /health endpoint during start up. We have found from experiment this can cut down the number of 502s returned from a load balancer in front of the collector in Kubernetes deployments.')),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.experimental.warmup.numRequestsAdded in version 2.7.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 2000. The number of requests to send if using the experimental warmup feature.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.experimental.warmup.maxConnectionsAdded in version 2.7.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 2000. How many TCP connections to open simultaneously when using the experimental warmup feature.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"akka.*"),(0,o.kt)("td",{parentName:"tr",align:null},"Set","\xa0","any standard akka http option. For example,","\xa0","akka.loglevel = INFO")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"akka.ssl-config.*"),(0,o.kt)("td",{parentName:"tr",align:null},"Deprecated since collector version 2.4.0. Since 2.4.0, SSL config is instead configured via JVM system properties. See below for details.")))),(0,o.kt)("h3",{id:"kinesis-collector-options"},"Kinesis collector options"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"collector.streams.good"),(0,o.kt)("th",{parentName:"tr",align:null},"Required. Name of the output kinesis stream for successfully collected events"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.bad"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. Name of the output kinesis stream for http requests which could not be written to the good stream. For example, if the event size exceeds the kinesis limit of 1MB.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.useIpAddressAsPartitionKey"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default false. Whether to use the user's IP address as the kinesis partition key.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.region"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, defaults to eu-central-1. AWS region of the kinesis streams.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.customEndpoint"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. Override the aws kinesis endpoints. Can be helpful when using localstack for testing.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.threadPoolSize"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 10. Configures the thread pool size used by the collector sink for asynchronous operations.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.sqsGoodBuffer"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. Set to the name of a SQS topic to enable buffering of good output events. When messages cannot be sent to Kinesis, (e.g. because of exceeding api limits) then they get sent to SQS as a fallback. Helpful for smoothing over traffic spikes.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.sqsBadBuffer"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. Like the sqsGoodBuffer but for failed events.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.aws.accessKey"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. Set to default to use the default provider chain; set to iam to use AWS IAM roles; or set to env to use the AWS_ACCESS_KEY_ID environment variable.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.aws.secretKey"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. Set to default to use the default provider chain; set to iam to use AWS IAM roles; or set to env to use the AWS_SECRET_ACCESS_KEY environment variable.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.backoffPolicy.minBackoff"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 3000. Time in milliseconds for retrying sending to kinesis / SQS after failure.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"colletor.streams.backoffPolicy.maxBackoff"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 600000. Time in milliseconds for retrying sending to kinesis / SQS after failure.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.byteLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 3145728. Incoming events are stored in an internal buffer before being sent to Kinesis. This configures the maximum total size of pending events.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.recordLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 50. Configures the maximum number of pending events before flushing to Kinesis.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.timeLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 5000. Configures the maximum time in milliseconds before flushing pending buffered events to Kinesis.")))),(0,o.kt)("h3",{id:"pubsub-collector-options"},"Pubsub collector options"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"collector.streams.good"),(0,o.kt)("th",{parentName:"tr",align:null},"Required. Name of the output Pubsub topic for successfully collected events"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.bad"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. Name of the output pubsub topic for http requests which could not be written to the good stream. For example, if the event size exceeds the Pubsub limit of 10MB.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.googleProjectId"),(0,o.kt)("td",{parentName:"tr",align:null},"Required. GCP project name.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.minBackoff"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 1000. Time in milliseconds for retrying sending to Pubsub after failure.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.maxBackoff"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 1000. Time in milliseconds for retrying sending to Pubsub after failure")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.totalBackoff"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 9223372036854. We set this to the maximum value so that we never give up on trying to send a message to pubsub.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.multipler"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 2. Configures time between retries after failing send message to Pubsub.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.initialRpcTimeoutAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 10000. Time in milliseconds before a RPC call to Pubsub is aborted and retried.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.maxRpcTimeoutAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 10000. Maximum time in milliseconds before RPC call to Pubsub is aborted and retried.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.sink.backoffPolicy.rpcTimeoutMultiplerAdded in version 2.5.0"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 2. Configures how RPC timeouts are allowed to increase as they are retried.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.byteLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 1000000. Incoming events are stored in an internal buffer before being sent to Pubsub. This configures the maximum total size of pending eve")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.recordLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 40. Configures the maximum number of pending events before flushing to Pubsub.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"collector.streams.buffer.timeLimit"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, default 1000. Configures the maximum time in milliseconds before flushing pending buffered events to Pubsub.")))),(0,o.kt)("h3",{id:"setting-the-domain-name"},"Setting the domain name"),(0,o.kt)("p",null,"Set the cookie name using the ",(0,o.kt)("inlineCode",{parentName:"p"},"collector.cookie.name"),' setting. To maintain backward compatibility with earlier versions of the collector, use the string "sp" as the cookie name.'),(0,o.kt)("p",null,"The collector responds to valid requests with a ",(0,o.kt)("inlineCode",{parentName:"p"},"Set-Cookie")," header, which may or may not specify a ",(0,o.kt)("inlineCode",{parentName:"p"},"domain")," for the cookie."),(0,o.kt)("p",null,"If no domain is specified, the cookie will be set against the full collector domain, for example ",(0,o.kt)("inlineCode",{parentName:"p"},"collector.snplow.com"),". That will mean that applications running elsewhere on ",(0,o.kt)("inlineCode",{parentName:"p"},"*.snplow.com")," won't be able to access it. If you don't need to grant access to the cookie from other applications on the domain, then you can ignore the ",(0,o.kt)("inlineCode",{parentName:"p"},"domains")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"fallbackDomain")," settings."),(0,o.kt)("p",null,"In earlier versions, you could specify a ",(0,o.kt)("inlineCode",{parentName:"p"},"domain")," to tie the cookie to. For example, if set to ",(0,o.kt)("inlineCode",{parentName:"p"},".snplow.com"),", the cookie would have been accessible to other applications running on ",(0,o.kt)("inlineCode",{parentName:"p"},"*.snplow.com"),". To do the same in this version, use the ",(0,o.kt)("inlineCode",{parentName:"p"},"fallbackDomain")," setting but ",(0,o.kt)("strong",{parentName:"p"},"make sure")," that you no longer include a leading dot:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'fallbackDomain = "snplow.com"\n')),(0,o.kt)("p",null,"The cookie set by the collector can be treated differently by browsers, depending on whether it's considered to be a first-party or a third-party cookie. In earlier versions (0.15.0 and earlier), if you had two collector endpoints, one on ",(0,o.kt)("inlineCode",{parentName:"p"},"collector.snplow.com")," and one on ",(0,o.kt)("inlineCode",{parentName:"p"},"collector.snplow.net"),", you could only specify one of those domains in the configuration. That meant that you were only able to set a first-party cookie server-side on either ",(0,o.kt)("inlineCode",{parentName:"p"},".snplow.com")," or ",(0,o.kt)("inlineCode",{parentName:"p"},".snplow.net"),", but not on both. From version 0.16.0, you can specify a list of domains to be used for the cookie (",(0,o.kt)("strong",{parentName:"p"},"note the lack of a leading dot"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'domains = [\n  "snplow.com"\n  "snplow.net"\n]\n')),(0,o.kt)("p",null,"Which domain to be used in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Set-Cookie")," header is determined by matching the domains from the ",(0,o.kt)("inlineCode",{parentName:"p"},"Origin")," header of the request to the specified list. The first match is used. If no matches are found, the fallback domain will be used, if configured. If no ",(0,o.kt)("inlineCode",{parentName:"p"},"fallbackDomain")," is configured, the cookie will be tied to the full collector domain."),(0,o.kt)("p",null,"If you specify a main domain in the list, all subdomains on it will be matched. If you specify a subdomain, only that subdomain will be matched."),(0,o.kt)("p",null,"Examples:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"domain.com")," will match ",(0,o.kt)("inlineCode",{parentName:"li"},"Origin")," headers like ",(0,o.kt)("inlineCode",{parentName:"li"},"domain.com"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"www.domain.com")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"secure.client.domain.com")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"client.domain.com")," will match an ",(0,o.kt)("inlineCode",{parentName:"li"},"Origin")," header like ",(0,o.kt)("inlineCode",{parentName:"li"},"secure.client.domain.com")," but not ",(0,o.kt)("inlineCode",{parentName:"li"},"domain.com")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"www.domain.com"),".")),(0,o.kt)("h3",{id:"configuring-custom-paths"},"Configuring custom paths"),(0,o.kt)("p",null,"The collector responds with a cookie to requests with a path that matches the ",(0,o.kt)("inlineCode",{parentName:"p"},"vendor/version")," protocol. The expected values are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"com.snowplowanalytics.snowplow/tp2")," for Tracker Protocol 2"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"r/tp2")," for redirects"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"com.snowplowanalytics.iglu/v1")," for the Iglu Webhook.")),(0,o.kt)("p",null,"You can also map any valid (ie, two-segment) path to one of the three defaults via the ",(0,o.kt)("inlineCode",{parentName:"p"},"collector.paths")," section of the configuration file. Your custom path must be the key and the value must be one of the corresponding default paths. Both must be full valid paths starting with a leading slash:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'paths {\n  "/com.acme/track"    = "/com.snowplowanalytics.snowplow/tp2"\n  "/com.acme/redirect" = "/r/tp2"\n  "/com.acme/iglu"     = "/com.snowplowanalytics.iglu/v1"\n}\n')),(0,o.kt)("h3",{id:"tls-port-binding-and-certificate-240"},"TLS port binding and certificate (2.4.0+)"),(0,o.kt)("p",null,'Since 2.4.0 TLS certificates are configured using JVM system parameters. The "',(0,o.kt)("inlineCode",{parentName:"p"},"Customizing JSSE"),'" section in ',(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/security/java-secure-socket-extension-jsse-reference-guide.html#GUID-A41282C3-19A3-400A-A40F-86F4DA22ABA9"},"Java 11 JSSE reference documentation")," explains all system properties in detail."),(0,o.kt)("p",null,"The following JVM properties are the ones to be used most of the time."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"System Property"),(0,o.kt)("th",{parentName:"tr",align:null},"Customized Item"),(0,o.kt)("th",{parentName:"tr",align:null},"Default"),(0,o.kt)("th",{parentName:"tr",align:null},"Notes"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"javax.net.ssl.keyStore")),(0,o.kt)("td",{parentName:"tr",align:null},"Default keystore; see ",(0,o.kt)("a",{parentName:"td",href:"https://docs.oracle.com/en/java/javase/11/security/java-secure-socket-extension-jsse-reference-guide.html#GUID-7D9F43B8-AABF-4C5B-93E6-3AFB18B66150"},"Customizing the Default Keystores and Truststores, Store Types, and Store Passwords")),(0,o.kt)("td",{parentName:"tr",align:null},"None"),(0,o.kt)("td",{parentName:"tr",align:null},"\xa0")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},"javax.net.ssl.keyStorePassword")),(0,o.kt)("td",{parentName:"tr",align:null},"Default keystore password; see ",(0,o.kt)("a",{parentName:"td",href:"https://docs.oracle.com/en/java/javase/11/security/java-secure-socket-extension-jsse-reference-guide.html#GUID-7D9F43B8-AABF-4C5B-93E6-3AFB18B66150"},"Customizing the Default Keystores and Truststores, Store Types, and Store Passwords")),(0,o.kt)("td",{parentName:"tr",align:null},"None"),(0,o.kt)("td",{parentName:"tr",align:null},"It is inadvisable to specify the password in a way that exposes it to discovery by other users.")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Password can not be empty.")," |\n| ",(0,o.kt)("inlineCode",{parentName:"p"},"javax.net.ssl.keyStoreType")," | Default keystore type; see ",(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/security/java-secure-socket-extension-jsse-reference-guide.html#GUID-7D9F43B8-AABF-4C5B-93E6-3AFB18B66150"},"Customizing the Default Keystores and Truststores, Store Types, and Store Passwords")," | ",(0,o.kt)("inlineCode",{parentName:"p"},"PKCS12")," | \xa0\xa0 |\n| ",(0,o.kt)("inlineCode",{parentName:"p"},"jdk.tls.server.cipherSuites")," | Server-side default enabled cipher suites. See ",(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/security/java-secure-socket-extension-jsse-reference-guide.html#GUID-D61663E8-2405-4B2D-A1F1-B8C7EA2688DB"},"Specifying Default Enabled Cipher Suites")," | See ",(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/security/oracle-providers.html#GUID-7093246A-31A3-4304-AC5F-5FB6400405E2__SUNJSSE_CIPHER_SUITES"},"SunJSSE Cipher Suites")," to determine which cipher suites are enabled by default | Caution: These system properties can be used to configure weak cipher suites, or the configured cipher suites may be weak in the future. It is not recommended that you use these system properties without understanding the risks. |\n| ",(0,o.kt)("inlineCode",{parentName:"p"},"jdk.tls.server.protocols")," | Default handshaking protocols for TLS/DTLS servers. See ",(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/security/oracle-providers.html#GUID-7093246A-31A3-4304-AC5F-5FB6400405E2"},"The SunJSSE Provider")," | None | To configure the default enabled protocol suite in the server-side of a SunJSSE provider, specify the protocols in a comma-separated list within quotation marks. The protocols in this list are standard SSL protocol names as described in ",(0,o.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/docs/specs/security/standard-names.html"},"Java Security Standard Algorithm Names"),". Note that this System Property impacts only the default protocol suite (SSLContext of the algorithms SSL, TLS and DTLS). If an application uses a version-specific SSLContext (SSLv3, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3, DTLSv1.0, or DTLSv1.2), or sets the enabled protocol version explicitly, this System Property has no impact. |"),(0,o.kt)("p",null,"A deployment would need a TLS certificate, preferably issued by a trusted CA, however, for test purposes, a TLS cert could be generated as follows"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'ssl_dir=/opt/snowplow/ssl\nmkdir -p ${ssl_dir}\n\nsudo openssl req \\\n  -x509 \\\n  -newkey rsa:4096 \\\n  -keyout ${ssl_dir}/collector_key.pem \\\n  -out ${ssl_dir}/collector_cert.pem \\\n  -days 3650 \\\n  -nodes \\\n  -subj "/C=UK/O=Acme/OU=DevOps/CN=*.acme.com"\n\nsudo openssl pkcs12 \\\n  -export \\\n  -out ${ssl_dir}/collector.p12 \\\n  -inkey ${ssl_dir}/collector_key.pem \\\n  -in ${ssl_dir}/collector_cert.pem \\\n  -passout pass:changeme\n\nsudo chmod 644 ${ssl_dir}/collector.p12\n')),(0,o.kt)("p",null,"and then the collector (kinesis as example) could be started as follows"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"config_dir=/opt/snowplow/config\n\ndocker run \\\n  -d \\\n  --name scala-stream-collector \\\n  --restart always \\\n  --network host \\\n  -v ${config_dir}:/snowplow/config \\\n  -v ${ssl_dir}:/snowplow/ssl \\\n  -p 8080:8080 \\\n  -p 8443:8443 \\\n  -e 'JAVA_OPTS=-Xms2g -Xmx2g -Djavax.net.ssl.keyStoreType=pkcs12 -Djavax.net.ssl.keyStorePassword=changeme -Djavax.net.ssl.keyStore=/snowplow/ssl/collector.p12 -Dorg.slf4j.simpleLogger.defaultLogLevel=warn -Dcom.amazonaws.sdk.disableCbor' \\\n  snowplow/scala-stream-collector-kinesis:2.5.0 \\\n  --config /snowplow/config/snowplow-stream-collector-kinesis-2.5.0.hocon\n")),(0,o.kt)("p",null,"Note: If you don't have a verified certificate, you need to disable SSL verification on client side. e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"cURL"),"'s ",(0,o.kt)("inlineCode",{parentName:"p"},"-k, --insecure")," flag disables it."),(0,o.kt)("h3",{id:"setting-up-an-sqs-buffer-200"},"Setting up an SQS buffer (2.0.0+)"),(0,o.kt)("p",null,"The lack of auto-scaling in Kinesis results in throttled streams in case of traffic spikes and Stream Collector starts accumulating events to retry them later. If accumulation continues long enough, Stream Collector will run out of memory. To prevent the possibility of a broken collector, we decided to make it possible to configure an SQS buffer that can provide additional assurance during extreme traffic spikes."),(0,o.kt)("p",null,"SQS is used to queue any message that Stream Collector failed to send to the Kinesis and the ",(0,o.kt)("a",{parentName:"p",href:"/docs/pipeline-components-and-applications/sqs2kinesis/"},(0,o.kt)("inlineCode",{parentName:"a"},"sqs2kinesis")," application")," is then responsible for reading the messages from SQS and writing to Kinesis once it is ready. In the event of any AWS API glitches, there is a retry mechanism which retries sending the SQS queue 10 times."),(0,o.kt)("p",null,"The keys set up for the Kinesis stream are stored as SQS message attributes in order to preserve the information. Note, the SQS messages cannot be as big as Kinesis messages. The limit is 256kB per message, but we send the messages as Base64 encoded, so the limit goes down to 192kB for the original message."),(0,o.kt)("h4",{id:"setting-up-the-sqs-queues"},"Setting up the SQS queues"),(0,o.kt)("p",null,"(This section only applies to the case when SQS is used as a fallback sink when Kinesis is unavailable. If you are using SQS as the primary sink, then the settings below should be ignored and the ",(0,o.kt)("inlineCode",{parentName:"p"},"good")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"bad")," streams should be configured as normal under ",(0,o.kt)("inlineCode",{parentName:"p"},"streams.good")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"streams.bad")," respectively.)"),(0,o.kt)("p",null,"To start using this feature, you will first need to set up the SQS queues. Two separate queues are required for good (raw) events and bad events. The Collector then needs to be informed about the queue names, and this can be done by adding these as entries to ",(0,o.kt)("inlineCode",{parentName:"p"},"config.hocon:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sqsGoodBuffer = {good-sqs-queue-url}\nsqsBadBuffer = {bad-sqs-queue-url}\n")),(0,o.kt)("h4",{id:"telemetry"},"Telemetry"),(0,o.kt)("p",null,"Starting with version 2.4.0 of the collector snowplow will be collecting the heartbeats with some meta-information about the application. This is an opt-out feature, meaning that it has to be explicitly disabled to stop it. Schema is available ",(0,o.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/snowplow/iglu-central/master/schemas/com.snowplowanalytics.oss/oss_context/jsonschema/1-0-1"},"here"),"."),(0,o.kt)("p",null,"At the base, telemetry is sending the application name and version every hour. This is done to help us to improve the product, we need to understand what is popular, so we could focus our development effort in the right place. You can help us by providing ",(0,o.kt)("inlineCode",{parentName:"p"},"userProvidedId")," in the config file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"telemetry {\n    userProvidedId = myCompany\n }\n")),(0,o.kt)("p",null,"Put the following entry into your configuration file to disable the telemetry."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"telemetry {\n    disable = true\n }\n")))}m.isMDXComponent=!0}}]);