<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-enriching-your-data/available-enrichments/custom-sql-enrichment/index">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159566509-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=GTM-M24XMJD"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","GTM-M24XMJD",{anonymize_ip:!0})</script><title data-rh="true">Custom SQL enrichment | Snowplow Documentation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.snowplowanalytics.com/docs/enriching-your-data/available-enrichments/custom-sql-enrichment"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Custom SQL enrichment | Snowplow Documentation"><meta data-rh="true" name="description" content="Summary"><meta data-rh="true" property="og:description" content="Summary"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.snowplowanalytics.com/docs/enriching-your-data/available-enrichments/custom-sql-enrichment"><link data-rh="true" rel="alternate" href="https://docs.snowplowanalytics.com/docs/enriching-your-data/available-enrichments/custom-sql-enrichment" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.snowplowanalytics.com/docs/enriching-your-data/available-enrichments/custom-sql-enrichment" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cb54eed0.css">
<link rel="preload" href="/assets/js/runtime~main.96240d76.js" as="script">
<link rel="preload" href="/assets/js/main.82ee80ee.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/snowplow-logo.svg" alt="Snowplow Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/snowplow-logo.svg" alt="Snowplow Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a aria-current="page" class="navbar__item navbar__link nav-link__first customized_AOMy navbar__link--active" href="/docs">Docs</a><a href="https://discourse.snowplowanalytics.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link undefined customized_AOMy">Discourse<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/snowplow/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link undefined customized_AOMy">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://try.snowplowanalytics.com/?utm_content=hero-cta&amp;utm_campaign=snowplow-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link snwpl-nav-button customized_AOMy">Try Snowplow</a><a href="https://go.snowplowanalytics.com/l/571483/2021-02-19/3sn5nml" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link snwpl-nav-button customized_AOMy">Book a demo</a><div class="toggle_vylO extraSpace_k8HL"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG extraPadding_YQbj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/getting-started-with-snowplow-bdp">Getting started on Snowplow BDP</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting started on Snowplow BDP&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/getting-started-on-snowplow-open-source">Getting started on Snowplow Open Source</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting started on Snowplow Open Source&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/try-snowplow">Try Snowplow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Try Snowplow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/open-source-quick-start">Snowplow Open Source Quick Start</a><button aria-label="Toggle the collapsible sidebar category &#x27;Snowplow Open Source Quick Start&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/understanding-your-pipeline">Understanding your pipeline</a><button aria-label="Toggle the collapsible sidebar category &#x27;Understanding your pipeline&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/understanding-tracking-design">Designing tracking</a><button aria-label="Toggle the collapsible sidebar category &#x27;Designing tracking&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/collecting-data">Collecting data with Trackers and Webhooks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Collecting data with Trackers and Webhooks&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/enriching-your-data">Enriching your data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Enriching your data&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/what-is-enrichment">What is the enrichment process?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/configuring-enrichments">Managing enrichments in the console</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/enriching-your-data/available-enrichments">Available enrichments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Available enrichments&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/iab-enrichment">IAB enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/ua-parser-enrichment">UA parser enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/currency-conversion-enrichment">Currency conversion enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/referrer-parser-enrichment">Referer parser enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/campaign-attribution-enrichment">Campaign attribution enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/event-fingerprint-enrichment">Event fingerprint enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/cookie-extractor-enrichment">Cookie extractor enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/http-header-extractor-enrichment">HTTP header extractor enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/yauaa-enrichment">YAUAA enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/ip-lookup-enrichment">IP Lookup enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/custom-javascript-enrichment">Custom JavaScript enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/enriching-your-data/available-enrichments/custom-sql-enrichment">Custom SQL enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/custom-api-request-enrichment">Custom API Request enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/ip-anonymization-enrichment">IP anonymization enrichment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/enriching-your-data/available-enrichments/pii-pseudonymization-enrichment">PII pseudonymization enrichment</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/modeling-your-data">Modeling your data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modeling your data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/forwarding-events-to-destinations">Forwarding events to Destinations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Forwarding events to Destinations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/managing-data-quality">Managing data quality</a><button aria-label="Toggle the collapsible sidebar category &#x27;Managing data quality&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/using-the-snowplow-console">Snowplow Console</a><button aria-label="Toggle the collapsible sidebar category &#x27;Snowplow Console&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/pipeline-components-and-applications">Pipeline Components and Applications</a><button aria-label="Toggle the collapsible sidebar category &#x27;Pipeline Components and Applications&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/contributing">Community &amp; contributing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Community &amp; contributing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/tutorials">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/enriching-your-data"><span itemprop="name">Enriching your data</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/enriching-your-data/available-enrichments"><span itemprop="name">Available enrichments</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Custom SQL enrichment</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Custom SQL enrichment</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>The SQL Query Enrichment lets you perform dimension widening on a Snowplow event via your own internal relational database.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" href="#overview" title="Direct link to heading">​</a></h2><p>If you have data points that you’d like to use to enrich your event data collected with Snowplow that live in a data base, this enrichment will help you to query for the fields you want to add.</p><p>Currently supported database types:</p><ul><li>MySQL, plus variants which speak MySQL (e.g. MariaDB, Amazon Aurora)</li><li>PostgreSQL, plus variants which speak PostgreSQL</li></ul><p>We don’t recommend to use this enrichment with analytical databases which support minimal (50-100) concurrent queries (e.g. Redshift).</p><p>To read more detail on this enrichnment and its configuration, look <a href="https://github.com/snowplow/snowplow/wiki/SQL-Query-enrichment" target="_blank" rel="noopener noreferrer">here</a>.</p><p>For help with configuring this enrichment and getting it live on your pipeline please contact us at <a href="mailto:support@snowplowanalytics.com" target="_blank" rel="noopener noreferrer">support@snowplowanalytics.com</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/snowplow/iglu-central/blob/master/schemas/com.snowplowanalytics.snowplow.enrichments/sql_query_enrichment_config/jsonschema/1-0-0" target="_blank" rel="noopener noreferrer">schema</a></li><li><a href="https://github.com/snowplow/enrich/blob/master/config/enrichments/sql_query_enrichment_config.json" target="_blank" rel="noopener noreferrer">example</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hypothetical-example">Hypothetical example<a class="hash-link" href="#hypothetical-example" title="Direct link to heading">​</a></h2><p>Below you can see an example configuration using imaginary PostgreSQL database with CRM data, used to widen Snowplow event with context containing information about users.</p><p>The configuration JSON for this enrichment contains four sub-objects:</p><ol><li><code>inputs</code> specifies the datapoint(s) from the Snowplow event to use as values to substitute placeholders in <code>query</code> when performing SQL query</li><li><code>database</code> defines how the enrichment can access your relational database</li><li><code>query</code> defines prepared SQL statement to query your database</li><li><code>output</code> lets you tune how you convert the returned row(s) into one or more self-describing JSONs ready to be attached to your Snowplow event</li><li><code>cache</code> improves the enrichment’s performance by storing rows retrieved from your relational database</li></ol><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;schema&quot;: &quot;iglu:com.snowplowanalytics.snowplow.enrichments/sql_query_enrichment_config/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;name&quot;: &quot;sql_query_enrichment_config&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;vendor&quot;: &quot;com.snowplowanalytics.snowplow.enrichments&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;enabled&quot;: true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;parameters&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;inputs&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;placeholder&quot;: 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;pojo&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;field&quot;: &quot;user_id&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;placeholder&quot;: 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;json&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;field&quot;: &quot;contexts&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;schemaCriterion&quot;: &quot;iglu:com.snowplowanalytics.snowplow/client_session/jsonschema/1-*-*&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;jsonPath&quot;: &quot;$.userId&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;placeholder&quot;: 2,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;pojo&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;field&quot;: &quot;app_id&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;database&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;postgresql&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;host&quot;: &quot;rdms.intra.acme.com&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;port&quot;: 5439,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;sslMode&quot;: true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;username&quot;: &quot;snowplow_enrich_ro&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;password&quot;: &quot;1asIkJed&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;database&quot;: &quot;crm&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;sql&quot;: &quot;SELECT username, email_address, date_of_birth FROM tbl_users WHERE user = ? AND application = ? LIMIT 1&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;output&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;expectedRows&quot;: &quot;AT_MOST_ONE&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;json&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;schema&quot;: &quot;iglu:com.acme/user/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;describes&quot;: &quot;ALL_ROWS&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;propertyNames&quot;: &quot;CAMEL_CASE&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;cache&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;size&quot;: 3000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;ttl&quot;: 60</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-1">Configuration<a class="hash-link" href="#configuration-1" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="inputs"><code>inputs</code><a class="hash-link" href="#inputs" title="Direct link to heading">​</a></h4><p>Specify an array of <code>inputs</code> to put instead of placeholders in prepared statement. Each input consists of a <code>placeholder</code> and a source: either <code>pojo</code> if the datapoint comes from the Snowplow enriched event POJO, or <code>json</code> if the datapoint comes from a self-describing JSON inside one of the three JSON fields. The <code>placeholder</code> is the index of the <code>?</code> SQL placeholder which this input will be used to populate. It must be an integer greater than or equal to 1. For the <code>pojo</code> source, the field name must be specified. A field name which is not recognized as part of the POJO will be ignored by the enrichment. For the <code>json</code> source, you must specify the field name as either <code>unstruct_event</code>, <code>contexts</code> or <code>derived_contexts</code>. You must then provide two additional fields:</p><ul><li><code>schemaCriterion</code> lets you specify the self-describing JSON you are looking for in the given JSON field. You can specify only the SchemaVer MODEL (e.g. <code>1-*-*</code>), MODEL plus REVISION (e.g. <code>1-1-*</code>) or a full MODEL-REVISION-ADDITION version (e.g. <code>1-1-1</code>)</li><li><code>jsonPath</code> lets you provide the <a href="https://github.com/gatling/jsonpath#jsonpath" target="_blank" rel="noopener noreferrer">JSON Path statement</a> to navigate to the field inside the JSON that you want to use as the input</li></ul><p>The lookup algorithm is short-circuiting: the first match for a given key will be used.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="database"><code>database</code><a class="hash-link" href="#database" title="Direct link to heading">​</a></h4><p>The <code>database</code> section lets you configure how the enrichment should access your relational database. At the moment <code>postgresql</code> and <code>mysql</code> are supported, with the same fields available for both. Please see the <strong>Database support</strong> section above for notes on compatibility. Populate all properties in the <code>postgresql</code> or <code>mysql</code> configuration object, as follows:</p><ul><li><code>host</code>, the hostname or IP address of the database server or cluster</li><li><code>port</code>, the port to connect to the database on</li><li><code>sslMode</code>, whether the database requires connections to use SSL</li><li><code>username</code>, the username to login to the database using</li><li><code>password</code>, the password for this username</li><li><code>database</code>, the name of the specific database to run the query against</li></ul><p><strong>We strongly recommend that the username have minimal read-only permissions on just the entities required to execute the SQL query.</strong> If your database server has additional authentication in place, such as IP whitelisting, you will need to configure this security to permit access from all of your servers running the Snowplow Enrichment process.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="query"><code>query</code><a class="hash-link" href="#query" title="Direct link to heading">​</a></h4><p>Consists of a single <code>sql</code> key with SQL query in a form of prepared statement to run on your relational database to return row(s) to attach to this event. Form of a prepared statement means it can has placeholders (<code>?</code>), which will be replaced with actual values, extracted from <code>input</code>s corresponding to their indexes. Some notes on the behavior:</p><ul><li>If a placeholder index required in the <code>sql</code> prepared statement is not found in any of the <code>inputs</code>, then the lookup will not proceed, but this will <strong>not</strong> be flagged as a failure</li><li>A final <code>;</code> is optional</li><li>Values will be inserted into prepared statement according to their type: strings will be quoted, number won’t</li><li><strong>This enrichment makes no attempt to sanitize the SQL statement, nor to verify that the SQL statement does not have harmful side effects (such as SQL injection)</strong></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="output"><code>output</code><a class="hash-link" href="#output" title="Direct link to heading">​</a></h4><p>The enrichment adds the returned row(s) into the <code>derived_contexts</code> field within a Snowplow enriched event. Because all JSONs in the <code>derived_contexts</code> field must be self-describing JSONs, use the <code>schema</code> field to specify the Iglu schema URI that you want to attach to the event. The <code>expectedRows</code> enum defines expected SQL output and can take the following values:</p><ul><li><code>EXACTLY_ONE</code> – exactly one row is expected. 0 or 2+ rows will throw an error, causing the entire event to fail processing</li><li><code>AT_MOST_ONE</code> – either one or zero rows is expected. 2+ rows will throw an error</li><li><code>AT_LEAST_ZERO</code> – between 0 and N rows are expected – in JSON terms we are dealing with an array of results</li><li><code>AT_LEAST_ONE</code> – between 1 and N rows are expected – i.e. an array of results. 0 rows will throw an error</li></ul><p>It is on user’s behalf to make sure SQL query returns correct amount of rows. The <code>describes</code> property dictates whether the <code>schema</code> is the self-describing schema for all rows returned by the query, or whether the <code>schema</code> should be attached to each of the returned rows:</p><ul><li><code>ALL_ROWS</code> means that the <code>schema</code> should box all returned rows – i.e. one context will always be added to <code>derived_contexts</code>, regardless of how many rows that schema contains</li><li><code>EVERY_ROW</code> means that the <code>schema</code> should be attached to each returned row – so e.g. if 3 rows are returned, 3 contexts with this same schema will be added to <code>derived_contexts</code></li></ul><p>The <code>propertyNames</code> property supports reformatting of the returned columns to fit the JSON Schema’s conventions better. Supported options are:</p><ul><li><code>AS_IS</code> – preserve the column names exactly as they are</li><li><code>CAMEL_CASE</code> – so <code>date_of_birth</code> becomes <code>dateOfBirth</code></li><li><code>PASCAL_CASE</code> – so <code>date_of_birth</code> becomes <code>DateOfBirth</code></li><li><code>SNAKE_CASE</code> – so <code>dateOfBirth</code> becomes <code>date_of_birth</code></li><li><code>LOWER_CASE</code> – changes all characters to lowercase</li><li><code>UPPER_CASE</code> – changes all characters to uppercase</li></ul><p>If these options aren’t bespoke enough, remember that you can use column aliasing in your SQL statement to tweak individual column names.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache"><code>cache</code><a class="hash-link" href="#cache" title="Direct link to heading">​</a></h4><p>A Snowplow enrichment can run many millions of time per hour, effectively launching a DoS attack on a data source if we are not careful. The <code>cache</code> configuration attempts to minimize the number of lookups performed. The cache is an LRU (least-recently used) cache, where less frequently accessed values are evicted to make space for new values. For the cache key, we use a complex object with an underlying Indexed HashMap, consisting of placeholder numbers as keys and extracted values as HashMap values. You can configure the <code>cache</code> as follows:</p><ul><li><code>size</code> is the maximum number of entries to hold in the cache at any one time</li><li><code>ttl</code> is the number of seconds that an entry can stay in the cache before it is forcibly evicted. This is useful to prevent stale values from being retrieved in the case that your DB can return different values for the same key over time</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="examples">Examples<a class="hash-link" href="#examples" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="single-row">Single row<a class="hash-link" href="#single-row" title="Direct link to heading">​</a></h3><p>With this configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sql&quot;: &quot;SELECT username, date_of_birth FROM tbl_users WHERE user = ?&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;output&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;expectedRows&quot;: &quot;AT_MOST_ONE&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;json&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;schema&quot;: &quot;iglu:com.acme/user/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;describes&quot;: &quot;ALL_ROWS&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;propertyNames&quot;: &quot;CAMEL_CASE&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And this query result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT username, date_of_birth FROM tbl_users WHERE user = 123;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| username | date_of_birth |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|----------|---------------|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|     karl |    1980-06-12 |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This would be added to the <code>derived_contexts</code> array:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;schema&quot;: &quot;iglu:com.acme/user/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;username&quot;: &quot;karl&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;dateOfBirth&quot;: &quot;1980-06-12T00:00:00&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this query result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT username, date_of_birth FROM tbl_users WHERE user = 123;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| username | date_of_birth |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|----------|---------------|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>No context would be added to the <code>derived_contexts</code> array, but the event would continue processing. With this query result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT username, date_of_birth FROM tbl_users WHERE user = 123;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| username | date_of_birth |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|----------|---------------|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|     karl |    1980-06-12 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|     mary |    1975-03-22 |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>An error would be triggered, on account of the <code>AT_MOST_ONE</code> setting, and the event would be rejected.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-rows">Multiple rows<a class="hash-link" href="#multiple-rows" title="Direct link to heading">​</a></h3><p>With this configuration:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sql&quot;: &quot;SELECT * FROM product WHERE category = ?&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;output&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;expectedRows&quot;: &quot;AT_LEAST_ZERO&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;json&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;schema&quot;: &quot;iglu:com.acme/products/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;describes&quot;: &quot;ALL_ROWS&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;propertyNames&quot;: &quot;AS_IS&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And this query result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT * FROM product WHERE category = &#x27;homeware&#x27;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| SKU | prod_name |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|-----|-----------|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| 123 |      iPad |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| 456 |  Ray-Bans |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This single context would be added to the <code>derived_contexts</code> array:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;schema&quot;: &quot;iglu:com.acme/products/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;SKU&quot;: &quot;123&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;prod_name&quot;: &quot;iPad&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;SKU&quot;: &quot;456&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;prod_name&quot;: &quot;Ray-Bans&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we change the configuration to:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;output&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;expectedRows&quot;: &quot;AT_LEAST_ZERO&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;json&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;schema&quot;: &quot;iglu:com.acme/product/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;describes&quot;: &quot;EVERY_ROW&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;propertyNames&quot;: &quot;LOWER_CASE&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then two contexts would be added to the <code>derived_contexts</code> array:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;schema&quot;: &quot;iglu:com.acme/product/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sku&quot;: &quot;123&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;prod_name&quot;: &quot;iPad&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;schema&quot;: &quot;iglu:com.acme/product/jsonschema/1-0-0&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sku&quot;: &quot;456&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;prod_name&quot;: &quot;Ray-Bans&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="algorithm">Algorithm<a class="hash-link" href="#algorithm" title="Direct link to heading">​</a></h3><p>This enrichment uses any relational database to fetch data in JSON format. Here are some clues on how this enrichment will handle some exceptional cases:</p><ul><li>if provided JSONPath is invalid – all events attempted to being enriched will be sent to <code>enriched/bad</code></li><li>if more than one context (derived or custom) matches <code>schemaCriterion</code> – first one will be picked, no matter if following have higher SchemaVer</li><li>if input’s value found more than in one sources – last one will be picked, so try to put more precise input last (for example to get longitude/latitude pair use data from IP Lookup enrichment first and GPS-derived longitude/latitude second)</li><li>if any of input key wasn’t found – SQL query won’t be performed and new context won’t be derived, but event will be processed as usual</li><li>if DB query wasn’t successful for any reason or timed-out – event will be sent to <code>enriched/bad</code> bucket</li><li>if DB connection was lost – event will be sent to <code>enriched/bad</code> bucket, but on next event, enrichment will try to reestablish connection</li><li>all non-primitive values (objects, arrays) and <code>null</code>s will be interpreted as not-found values</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-generated">Data generated<a class="hash-link" href="#data-generated" title="Direct link to heading">​</a></h3><p>This enrichment adds a new context to the enriched event with <a href="https://github.com/snowplow/iglu-central/blob/master/schemas/com.snowplowanalytics.snowplow/ua_parser_context/jsonschema/1-0-0" target="_blank" rel="noopener noreferrer">this schema</a>.</p><p>As during the SQL Query enrichment process the new context is added to <code>derived_contexts</code> of the enriched/good event, the data generated will end up in its own table determined by the custom <code>schema</code> key in <code>output</code> configuration sub-object.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/snowplow/snowplow.github.io/tree/main/docs/enriching-your-data/available-enrichments/custom-sql-enrichment/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-08-26T15:15:03.000Z">Aug 26, 2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/enriching-your-data/available-enrichments/custom-javascript-enrichment"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Custom JavaScript enrichment</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/enriching-your-data/available-enrichments/custom-api-request-enrichment"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Custom API Request enrichment</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#hypothetical-example" class="table-of-contents__link toc-highlight">Hypothetical example</a></li><li><a href="#configuration-1" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a><ul><li><a href="#single-row" class="table-of-contents__link toc-highlight">Single row</a></li><li><a href="#multiple-rows" class="table-of-contents__link toc-highlight">Multiple rows</a></li><li><a href="#algorithm" class="table-of-contents__link toc-highlight">Algorithm</a></li><li><a href="#data-generated" class="table-of-contents__link toc-highlight">Data generated</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a class="footer__link-item" href="/cookie-settings">Change cookie settings</a><span class="footer__link-separator">·</span><a class="footer__link-item" href="/terms-and-conditions">Terms and conditions</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Snowplow Analytics Ltd. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.96240d76.js"></script>
<script src="/assets/js/main.82ee80ee.js"></script>
</body>
</html>